{{- if (eq .chezmoi.os "darwin") -}}
#!/usr/bin/env bash
set -eufo pipefail

bundleid_of() {
  osascript -e "id of application \"$1\"" > /dev/null 2>&1
}

# CLI Apps
{{ $brews := list
        "asdf"
        "atuin"
        "bat"
        "bottom"
        "brew-cask-completion"
        "cloc"
        "coreutils"
        "exa"
        "fish"
        "git"
        "git-delta"
        "git-quick-stats"
        "jq"
        "micro"
        "openssl"
        "poppler"
        "ssh-copy-id"
        "starship"
        "terminal-notifier"
        "svn"
        "tldr"
        "wakeonlan"
        "wget"
        "youtube-dl"
        "yq"
        "zoxide"
 -}}

# GUI Apps
{{ $casks := list
        "alfred"
        "audio-hijack"
        "bitwarden"
        "clipy"
        "coconutbattery"
        "disk-inventory-x"
        "dozer"
        "fanny"
        "finicky"
        "firefox-developer-edition"
        "flux"
        "fork"
        "forklift"
        "google-chrome"
        "gpg-suite-no-mail"
        "hammerspoon"
        "iina"
        "imageoptim"
        "istat-menus"
        "iterm2"
        "keka"
        "noti"
        "pdf-expert"
        "postman"
        "rectangle"
        "slack"
        "spotify"
        "sublime-text"
        "teamviewer"
        "telegram"
        "visual-studio-code"
        "whatsapp"
        "zoom"
-}}

# Quicklook plugins
{{   $casks = concat $casks (list
        "qlcolorcode"
        "qlstephen"
        "qlmarkdown"
        "quicklook-json"
        "qlprettypatch"
        "quicklook-csv"
        "betterzip"
        "webpquicklook"
        "suspicious-package"
        )
 -}}

# Fonts
{{   $casks = concat $casks (list
        "font-jetbrains-mono"
        "font-fira-code-nerd-font"
        "font-fira-mono-for-powerline"
        "font-cascadia-code-pl"
        "font-cascadia-mono-pl"
        )
 -}}

{{ if .personal -}}
{{   $casks = concat $casks (list
        "airtable"
        "android-platform-tools"
        "dropbox"
        "farrago"
        "google-drive"
        "keybase"
        "obsidian"
        "pycharm-ce"
        "skype"
        )
 -}}
{{ end -}}

all_brews=({{ range ($brews | sortAlpha | uniq) -}}{{ . }} {{ end -}})
already_installed_brews=($(brew leaves))
all_casks=({{ range ($casks | sortAlpha | uniq) -}}{{ . }} {{ end -}})
already_installed_casks=($(brew list --cask))

brews_to_install=()
for brew in "${all_brews[@]}"; do
    if [[ ! " ${already_installed_brews[*]} " =~ " ${brew} " ]]; then
        brews_to_install+=($brew)
    fi
done

casks_to_install=()
for cask in "${all_casks[@]}"; do
    if [[ ! " ${already_installed_casks[*]} " =~ " ${cask} " ]]; then
        cask_app_file = brew info --cask ${cask} | grep "(App)" | awk '{print $1}'

        # This identifies apps that were not installed as Brew casks  
        if ! bundleid_of "${cask_app_file}"; then
          casks_to_install+=($cask)
        fi
    fi
done

brew bundle --no-lock --file=/dev/stdin <<EOF
tap "homebrew/cask-fonts"
tap "homebrew/cask-versions"

$(
  if (( ${#brews_to_install[@]} )); then
    for brew in "${brews_to_install[@]}"; do
        echo brew \"${brew}\"
    done
  fi
)

$(
  if (( ${#casks_to_install[@]} )); then
    for cask in "${casks_to_install[@]}"; do
        echo cask \"${cask}\"
    done
  fi
)

# GUI Apps from App Store
mas "Amphetamine", id: 937984704
mas "ColorSlurp", id: 1287239339
EOF
{{ end -}}
